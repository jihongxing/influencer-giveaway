# Change Proposal: æ´»åŠ¨å…ƒæ•°æ®æ”¶é›†ä¸æ‰¹é‡ä¸Šæ¶ä¼˜åŒ–

**ææ¡ˆç¼–å·**: CP-002  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-27  
**çŠ¶æ€**: Draft  
**ä¼˜å…ˆçº§**: High  
**å½±å“èŒƒå›´**: æ´»åŠ¨åˆ›å»ºæµç¨‹ã€ç‰©å“ä¸Šä¼ æµç¨‹ã€æ•°æ®æ¨¡å‹  

---

## æ¦‚è¿° (Overview)

### å½“å‰é—®é¢˜ (Current State)

ç›®å‰çš„æ´»åŠ¨åˆ›å»ºæµç¨‹è¿‡äºç®€åŒ–ï¼Œç½‘çº¢ç›´æ¥ä¸Šä¼ ç‰©å“ç…§ç‰‡å³å¯åˆ›å»ºæ´»åŠ¨ã€‚è¿™å¯¼è‡´ï¼š

1. **æ´»åŠ¨ä¿¡æ¯ä¸å®Œæ•´**ï¼šç¼ºå°‘æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€æè¿°ã€å¹³å°æ¥æºç­‰ï¼‰
2. **æ—¶é—´ç®¡ç†ç¼ºå¤±**ï¼šæ²¡æœ‰æ´»åŠ¨å¼€å§‹æ—¶é—´çš„æ¦‚å¿µï¼Œæ— æ³•æå‰å‡†å¤‡æˆ–å®šæ—¶å‘å¸ƒ
3. **è®¿é—®æ§åˆ¶ç¼ºå¤±**ï¼šæ‰€æœ‰æ´»åŠ¨éƒ½æ˜¯å…¬å¼€çš„ï¼Œæ— æ³•å®ç°ç§å¯†æ´»åŠ¨æˆ–ç‰¹å®šç²‰ä¸ç¾¤ä½“è®¿é—®
4. **ç‰©æµæ•ˆç‡ä½**ï¼šæ²¡æœ‰ä¼˜é€‰å¿«é€’è®¾ç½®ï¼Œæ¯ä¸ªè®¢å•éƒ½éœ€è¦é‡æ–°é€‰æ‹©å¿«é€’å…¬å¸
5. **ä¸Šæ¶æ•ˆç‡ä½**ï¼šæ¯ä¸ªç‰©å“éœ€è¦å•ç‹¬å¤„ç†ï¼Œæ— æ³•æ‰¹é‡ä¸Šæ¶ç›¸åŒ/ç›¸ä¼¼ç‰©å“

### æè®®æ”¹è¿› (Proposed Changes)

**ä¸¤é˜¶æ®µæ´»åŠ¨åˆ›å»ºæµç¨‹**ï¼š

**é˜¶æ®µä¸€ï¼šæ´»åŠ¨ä¿¡æ¯å½•å…¥**ï¼ˆæ–°å¢ï¼‰
- æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ï¼šæ ‡é¢˜ã€æè¿°ã€å°é¢å›¾
- å‘å¸ƒå¹³å°ä¸æ—¶é—´ï¼šæ¥æºå¹³å°ã€é¢„è®¡å¼€å§‹æ—¶é—´ã€æ˜¯å¦ç«‹å³å‘å¸ƒ
- è®¿é—®æ§åˆ¶ï¼šæ˜¯å¦éœ€è¦å¯†ç ã€å¯†ç æç¤º
- ç‰©æµé…ç½®ï¼šä¼˜é€‰å¿«é€’å…¬å¸ã€å‘è´§åœ°å€

**é˜¶æ®µäºŒï¼šç‰©å“æ‰¹é‡ä¸Šæ¶**ï¼ˆä¼˜åŒ–ï¼‰
- æ‹ç…§ä¸Šä¼ ç‰©å“
- è¾“å…¥ç‰©å“æ•°é‡
- æ‰¹é‡ç”Ÿæˆç‰©å“è®°å½•ï¼ˆåŒä¸€ç…§ç‰‡å¯ç”Ÿæˆå¤šä¸ªç›¸åŒç‰©å“ï¼‰
- AIè¯†åˆ«ä¸æ ‡è®°

### ä»·å€¼ä¸»å¼  (Value Proposition)

1. **æ›´å¥½çš„æ´»åŠ¨ç®¡ç†**ï¼šå®Œæ•´çš„æ´»åŠ¨ä¿¡æ¯ä¾¿äºç½‘çº¢ç®¡ç†å’Œç²‰ä¸ç†è§£
2. **çµæ´»çš„å‘å¸ƒç­–ç•¥**ï¼šæ”¯æŒå®šæ—¶å‘å¸ƒå’Œæå‰é¢„çƒ­
3. **éšç§ä¿æŠ¤**ï¼šå¯†ç ä¿æŠ¤åŠŸèƒ½å¯å®ç°VIPç²‰ä¸ä¸“äº«æ´»åŠ¨
4. **æå‡ç‰©æµæ•ˆç‡**ï¼šé¢„è®¾ä¼˜é€‰å¿«é€’å‡å°‘å†³ç­–æ—¶é—´ï¼Œæé«˜å‘è´§é€Ÿåº¦
5. **æ‰¹é‡æ“ä½œ**ï¼šå¤§å¹…æé«˜ä¸Šæ¶æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯å¤šä»¶ç›¸åŒç‰©å“çš„åœºæ™¯

---

## è¯¦ç»†è®¾è®¡ (Detailed Design)

### 1. æ–°å¢æ•°æ®å­—æ®µ

#### Activities é›†åˆæ‰©å±•

```javascript
{
  // åŸæœ‰å­—æ®µ
  _id: String,
  influencer_id: String,
  status: String,
  share_link: String,
  qr_code_url: String,
  created_at: Date,
  updated_at: Date,
  published_at: Date,
  
  // æ–°å¢å­—æ®µ
  title: String,                    // æ´»åŠ¨æ ‡é¢˜ (å¿…å¡«, 1-50å­—ç¬¦)
  description: String,              // æ´»åŠ¨æè¿° (é€‰å¡«, 0-500å­—ç¬¦)
  cover_image_url: String,          // æ´»åŠ¨å°é¢å›¾URL (é€‰å¡«)
  source_platform: String,          // æ¥æºå¹³å°: 'douyin'|'xiaohongshu'|'wechat'|'other'
  scheduled_start_time: Date,       // é¢„è®¡å¼€å§‹æ—¶é—´ (é€‰å¡«)
  is_immediate_publish: Boolean,    // æ˜¯å¦ç«‹å³å‘å¸ƒ (é»˜è®¤true)
  
  // è®¿é—®æ§åˆ¶
  is_password_protected: Boolean,   // æ˜¯å¦éœ€è¦å¯†ç  (é»˜è®¤false)
  access_password: String,          // è®¿é—®å¯†ç  (4-8ä½æ•°å­—æˆ–å­—æ¯)
  password_hint: String,            // å¯†ç æç¤º (é€‰å¡«, 0-50å­—ç¬¦)
  
  // ç‰©æµé…ç½®
  preferred_courier: String,        // ä¼˜é€‰å¿«é€’: 'shunfeng'|'yuantong'|'zhongtong'|'yunda'|null
  sender_address: Object,           // å‘è´§åœ°å€ (JSON)
  sender_contact_name: String,      // å‘è´§äººå§“å
  sender_contact_phone: String,     // å‘è´§äººç”µè¯
  
  // ç»Ÿè®¡ä¿¡æ¯
  total_items_count: Number,        // æ€»ç‰©å“æ•°é‡ (é»˜è®¤0)
  available_items_count: Number,    // å¯ç”¨ç‰©å“æ•°é‡ (é»˜è®¤0)
  view_count: Number,               // æµè§ˆæ¬¡æ•° (é»˜è®¤0)
  access_attempts: Number           // å¯†ç å°è¯•æ¬¡æ•° (é»˜è®¤0)
}
```

#### Items é›†åˆæ‰©å±•

```javascript
{
  // åŸæœ‰å­—æ®µ
  _id: String,
  activity_id: String,
  photo_urls: Array<String>,
  ai_category: String,
  ai_tags: Array<String>,
  label: String,
  marker_name: String,
  marker_quantity: Number,
  marker_notes: String,
  shipping_cost_estimate: Number,
  status: String,
  qr_code_data: String,
  created_at: Date,
  updated_at: Date,
  
  // æ–°å¢å­—æ®µ
  batch_id: String,                 // æ‰¹æ¬¡ID (åŒä¸€æ‰¹ä¸Šä¼ çš„ç‰©å“å…±äº«)
  sequence_number: Number,          // åºå· (åŒæ‰¹æ¬¡å†…çš„åºå·, 1-N)
  original_quantity: Number,        // åŸå§‹ä¸Šä¼ æ—¶çš„æ•°é‡
  is_batch_generated: Boolean       // æ˜¯å¦ä¸ºæ‰¹é‡ç”Ÿæˆ (é»˜è®¤false)
}
```

### 2. ç”¨æˆ·æµç¨‹è®¾è®¡

#### 2.1 æ´»åŠ¨ä¿¡æ¯å½•å…¥é¡µé¢

**é¡µé¢è·¯å¾„**: `pages/create-activity-info/create-activity-info`

**è¡¨å•å­—æ®µ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºèµ é€æ´»åŠ¨                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  æ´»åŠ¨æ ‡é¢˜ *                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¾‹å¦‚ï¼šæ˜¥èŠ‚æ¸…ä»“å¤§æ”¾é€              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  æ´»åŠ¨æè¿°                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç®€å•ä»‹ç»ä¸€ä¸‹æ´»åŠ¨å†…å®¹...           â”‚ â”‚
â”‚  â”‚                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  æ´»åŠ¨å°é¢ï¼ˆé€‰å¡«ï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ +   â”‚  ç‚¹å‡»ä¸Šä¼                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                         â”‚
â”‚  æ¥æºå¹³å° *                             â”‚
â”‚  â—‹ æŠ–éŸ³  â—‹ å°çº¢ä¹¦  â—‹ å¾®ä¿¡  â—‹ å…¶ä»–    â”‚
â”‚                                         â”‚
â”‚  å¼€å§‹æ—¶é—´                               â”‚
â”‚  â–¡ ç«‹å³å‘å¸ƒ                            â”‚
â”‚  â–¡ å®šæ—¶å‘å¸ƒ  [é€‰æ‹©æ—¶é—´]                â”‚
â”‚                                         â”‚
â”‚  è®¿é—®æ§åˆ¶                               â”‚
â”‚  â–¡ è®¾ç½®è®¿é—®å¯†ç                         â”‚
â”‚     å¯†ç : â”Œâ”€â”€â”€â”€â”€â”€â”  æç¤º: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚          â”‚      â”‚         â”‚         â”‚ â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  ä¼˜é€‰å¿«é€’                               â”‚
â”‚  â—‹ é¡ºä¸°  â—‹ åœ†é€š  â—‹ ä¸­é€š  â—‹ éŸµè¾¾      â”‚
â”‚  â—‹ ä¸æŒ‡å®š                              â”‚
â”‚                                         â”‚
â”‚  å‘è´§åœ°å€ *                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [é€‰æ‹©åœ°å€]                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  å‘è´§äººä¿¡æ¯ *                           â”‚
â”‚  å§“å: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  ç”µè¯: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚       â”‚        â”‚        â”‚          â”‚â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚         [å–æ¶ˆ]      [ä¸‹ä¸€æ­¥ï¼šæ·»åŠ ç‰©å“]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒè¯è§„åˆ™**ï¼š
- æ´»åŠ¨æ ‡é¢˜ï¼šå¿…å¡«ï¼Œ1-50å­—ç¬¦
- æ´»åŠ¨æè¿°ï¼šé€‰å¡«ï¼Œæœ€å¤š500å­—ç¬¦
- æ¥æºå¹³å°ï¼šå¿…é€‰
- è®¿é—®å¯†ç ï¼šå¦‚å¯ç”¨ï¼Œ4-8ä½å­—ç¬¦
- å‘è´§åœ°å€ï¼šå¿…å¡«
- å‘è´§äººä¿¡æ¯ï¼šå¿…å¡«ï¼Œç”µè¯éœ€ç¬¦åˆæ‰‹æœºå·æ ¼å¼

#### 2.2 æ‰¹é‡ä¸Šæ¶ç‰©å“é¡µé¢

**é¡µé¢è·¯å¾„**: `pages/batch-upload-items/batch-upload-items`

**æ“ä½œæµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ·»åŠ ç‰©å“                               â”‚
â”‚  æ´»åŠ¨ï¼šæ˜¥èŠ‚æ¸…ä»“å¤§æ”¾é€                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ‹ç…§æˆ–é€‰æ‹©ç…§ç‰‡                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚ç…§ç‰‡1â”‚ç…§ç‰‡2â”‚ç…§ç‰‡3â”‚ +   â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  å·²æ·»åŠ ç‰©å“åˆ—è¡¨ï¼š                       â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ–¼ [ç…§ç‰‡]  Nikeè¿åŠ¨é‹              â”‚ â”‚
â”‚  â”‚    æ•°é‡: [3] ä»¶  AIè¯†åˆ«: é‹ç±»     â”‚ â”‚
â”‚  â”‚    [ç¼–è¾‘] [åˆ é™¤]                  â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ğŸ–¼ [ç…§ç‰‡]  iPhoneæ‰‹æœºå£³            â”‚ â”‚
â”‚  â”‚    æ•°é‡: [5] ä»¶  AIè¯†åˆ«: é…ä»¶     â”‚ â”‚
â”‚  â”‚    [ç¼–è¾‘] [åˆ é™¤]                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  æ‰¹é‡è®¾ç½®ï¼š                             â”‚
â”‚  ç‰©å“æ ‡è®°å‰ç¼€: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚               â”‚ITEM_   â”‚              â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                         â”‚
â”‚         [è¿”å›]      [å®Œæˆå¹¶å‘å¸ƒæ´»åŠ¨]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‰¹é‡ç”Ÿæˆé€»è¾‘**ï¼š
1. ç”¨æˆ·ä¸ºæ¯å¼ ç…§ç‰‡è¾“å…¥æ•°é‡ï¼ˆé»˜è®¤1ï¼‰
2. ç³»ç»Ÿä¸ºæ¯å¼ ç…§ç‰‡ç”Ÿæˆä¸€ä¸ªbatch_id
3. æ ¹æ®æ•°é‡ç”Ÿæˆå¯¹åº”æ•°é‡çš„itemè®°å½•
4. æ¯ä¸ªitemæœ‰ç‹¬ç«‹çš„sequence_number (1, 2, 3...)
5. æ‰€æœ‰itemå…±äº«åŒä¸€ç»„photo_urlså’ŒAIè¯†åˆ«ç»“æœ
6. è‡ªåŠ¨ç”Ÿæˆmarker_name: `{prefix}_{batch_id}_{sequence}`

### 3. äº‘å‡½æ•°ä¿®æ”¹

#### 3.1 activities äº‘å‡½æ•°æ–°å¢ action

**createWithMetadata** (åˆ›å»ºæ´»åŠ¨å«å…ƒæ•°æ®)

```javascript
async function createWithMetadata(openid, data) {
  const {
    title,
    description,
    cover_image_url,
    source_platform,
    scheduled_start_time,
    is_immediate_publish,
    is_password_protected,
    access_password,
    password_hint,
    preferred_courier,
    sender_address,
    sender_contact_name,
    sender_contact_phone
  } = data;

  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!title || title.length < 1 || title.length > 50) {
    return {
      success: false,
      error: {
        code: 'INVALID_TITLE',
        message: 'Title must be 1-50 characters'
      }
    };
  }

  if (!source_platform || !['douyin', 'xiaohongshu', 'wechat', 'other'].includes(source_platform)) {
    return {
      success: false,
      error: {
        code: 'INVALID_PLATFORM',
        message: 'Invalid source platform'
      }
    };
  }

  if (!sender_address || !sender_contact_name || !sender_contact_phone) {
    return {
      success: false,
      error: {
        code: 'MISSING_SENDER_INFO',
        message: 'Sender information is required'
      }
    };
  }

  // éªŒè¯å¯†ç 
  if (is_password_protected) {
    if (!access_password || !/^[A-Za-z0-9]{4,8}$/.test(access_password)) {
      return {
        success: false,
        error: {
          code: 'INVALID_PASSWORD',
          message: 'Password must be 4-8 alphanumeric characters'
        }
      };
    }
  }

  // åˆ›å»ºæ´»åŠ¨
  const result = await db.collection('activities').add({
    data: {
      influencer_id: openid,
      title,
      description: description || '',
      cover_image_url: cover_image_url || null,
      source_platform,
      scheduled_start_time: scheduled_start_time || null,
      is_immediate_publish: is_immediate_publish !== false,
      is_password_protected: is_password_protected || false,
      access_password: is_password_protected ? access_password : null,
      password_hint: password_hint || null,
      preferred_courier: preferred_courier || null,
      sender_address: JSON.stringify(sender_address),
      sender_contact_name,
      sender_contact_phone,
      total_items_count: 0,
      available_items_count: 0,
      view_count: 0,
      access_attempts: 0,
      status: is_immediate_publish ? 'draft' : 'scheduled',
      created_at: db.serverDate(),
      updated_at: db.serverDate()
    }
  });

  return {
    success: true,
    data: {
      activity_id: result._id,
      status: is_immediate_publish ? 'draft' : 'scheduled'
    }
  };
}
```

**verifyPassword** (éªŒè¯è®¿é—®å¯†ç )

```javascript
async function verifyPassword(data) {
  const { activity_id, password } = data;

  const activity = await db.collection('activities')
    .doc(activity_id)
    .get();

  if (!activity.data) {
    return {
      success: false,
      error: {
        code: 'ACTIVITY_NOT_FOUND',
        message: 'Activity not found'
      }
    };
  }

  if (!activity.data.is_password_protected) {
    return {
      success: true,
      data: { access_granted: true }
    };
  }

  // è®°å½•å°è¯•æ¬¡æ•°
  await db.collection('activities')
    .doc(activity_id)
    .update({
      data: {
        access_attempts: db.command.inc(1)
      }
    });

  if (activity.data.access_password === password) {
    return {
      success: true,
      data: { 
        access_granted: true,
        activity: activity.data
      }
    };
  }

  return {
    success: false,
    error: {
      code: 'INCORRECT_PASSWORD',
      message: 'Incorrect password',
      hint: activity.data.password_hint
    }
  };
}
```

#### 3.2 items äº‘å‡½æ•°æ–°å¢ action

**batchUpload** (æ‰¹é‡ä¸Šä¼ ç‰©å“)

```javascript
async function batchUpload(openid, data) {
  const { activity_id, items_data, marker_prefix } = data;

  // éªŒè¯æ´»åŠ¨æ‰€æœ‰æƒ
  const activity = await db.collection('activities')
    .doc(activity_id)
    .get();

  if (!activity.data || activity.data.influencer_id !== openid) {
    return {
      success: false,
      error: {
        code: 'PERMISSION_DENIED',
        message: 'Permission denied'
      }
    };
  }

  const batch_id = `batch_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const created_items = [];

  // éå†æ¯ä¸ªç‰©å“æ•°æ®ï¼ˆæ¯å¼ ç…§ç‰‡ï¼‰
  for (let i = 0; i < items_data.length; i++) {
    const item_data = items_data[i];
    const { photo_urls, quantity, ai_category, ai_tags } = item_data;

    // ä¸ºæ¯ä¸ªæ•°é‡ç”Ÿæˆç‹¬ç«‹çš„itemè®°å½•
    for (let seq = 1; seq <= quantity; seq++) {
      const marker_name = `${marker_prefix || 'ITEM'}_${batch_id}_${i + 1}_${seq}`;

      const result = await db.collection('items').add({
        data: {
          activity_id,
          photo_urls,
          ai_category: ai_category || 'uncategorized',
          ai_tags: ai_tags || [],
          label: '',
          marker_name,
          marker_quantity: 1,
          marker_notes: '',
          batch_id,
          sequence_number: seq,
          original_quantity: quantity,
          is_batch_generated: quantity > 1,
          status: 'available',
          qr_code_data: `marker_${activity_id}_${marker_name}`,
          created_at: db.serverDate(),
          updated_at: db.serverDate()
        }
      });

      created_items.push({
        item_id: result._id,
        marker_name,
        sequence: seq
      });
    }
  }

  // æ›´æ–°æ´»åŠ¨çš„ç‰©å“ç»Ÿè®¡
  await db.collection('activities')
    .doc(activity_id)
    .update({
      data: {
        total_items_count: db.command.inc(created_items.length),
        available_items_count: db.command.inc(created_items.length),
        updated_at: db.serverDate()
      }
    });

  return {
    success: true,
    data: {
      batch_id,
      created_count: created_items.length,
      items: created_items
    }
  };
}
```

### 4. é¡µé¢è·¯ç”±è°ƒæ•´

åŸæµç¨‹ï¼š
```
pages/create-giveaway â†’ pages/giveaway (å‘å¸ƒå®Œæˆ)
```

æ–°æµç¨‹ï¼š
```
pages/create-activity-info (æ´»åŠ¨ä¿¡æ¯) 
  â†’ pages/batch-upload-items (æ‰¹é‡ä¸Šä¼ ç‰©å“)
    â†’ pages/activity-preview (é¢„è§ˆ)
      â†’ pages/giveaway (å‘å¸ƒå®Œæˆ)
```

### 5. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```javascript
// activities é›†åˆç´¢å¼•
{
  "influencer_id": 1,
  "status": 1,
  "scheduled_start_time": 1
}

{
  "is_password_protected": 1,
  "status": 1
}

// items é›†åˆç´¢å¼•
{
  "activity_id": 1,
  "batch_id": 1,
  "sequence_number": 1
}

{
  "batch_id": 1,
  "status": 1
}
```

---

## ç”¨æˆ·æ•…äº‹æ›´æ–° (Updated User Stories)

### ä¿®è®¢åçš„ User Story 1

**Given** an influencer has completed registration,  
**When** they create a new giveaway activity,  
**Then** they are guided through a two-step process:

**Step 1 - Activity Information**:
1. Enter activity title and description
2. Select source platform (Douyin/Xiaohongshu/WeChat/Other)
3. Choose publish strategy (immediate or scheduled)
4. Optionally set access password for exclusive access
5. Select preferred courier and provide sender information

**Step 2 - Batch Item Upload**:
1. Upload photos of items
2. Input quantity for each photo (system generates multiple items)
3. Review AI-identified categories
4. System generates unique markers for each item
5. Publish activity with all items

**Acceptance Criteria**:
- Activity contains complete metadata before items are added
- System supports batch generation of identical items from single photo
- Each item has unique marker even if from same photo
- Preferred courier is pre-selected for all orders from this activity
- Password-protected activities require password to view

---

## è¾¹ç¼˜æ¡ˆä¾‹ (Edge Cases)

### æ–°å¢è¾¹ç¼˜æ¡ˆä¾‹

1. **å®šæ—¶å‘å¸ƒæœªåˆ°æ—¶é—´è®¿é—®**
   - ç”¨æˆ·å°è¯•åœ¨scheduled_start_timeä¹‹å‰è®¿é—®
   - å¤„ç†ï¼šæ˜¾ç¤º"æ´»åŠ¨å°šæœªå¼€å§‹"ï¼Œå±•ç¤ºå€’è®¡æ—¶

2. **å¯†ç å¤šæ¬¡é”™è¯¯**
   - ç”¨æˆ·è¿ç»­è¾“å…¥é”™è¯¯å¯†ç è¶…è¿‡5æ¬¡
   - å¤„ç†ï¼šä¸´æ—¶é”å®š10åˆ†é’Ÿï¼Œé€šçŸ¥ç½‘çº¢

3. **æ‰¹é‡ä¸Šä¼ æ•°é‡è¿‡å¤§**
   - å•æ¬¡ä¸Šä¼ ç‰©å“æ€»æ•°è¶…è¿‡100ä»¶
   - å¤„ç†ï¼šæ‹†åˆ†ä¸ºå¤šä¸ªæ‰¹æ¬¡ï¼Œåˆ†æ‰¹å¤„ç†

4. **ç›¸åŒbatch_idçš„ç‰©å“è¢«éƒ¨åˆ†é¢†å–**
   - åŒä¸€æ‰¹æ¬¡5ä»¶ç‰©å“ä¸­æœ‰3ä»¶è¢«é¢†å–
   - å¤„ç†ï¼šæ­£å¸¸ï¼Œæ¯ä¸ªitemç‹¬ç«‹çŠ¶æ€ï¼Œä¸å½±å“å…¶ä»–

5. **æ´»åŠ¨åˆ›å»ºåä¿®æ”¹ä¼˜é€‰å¿«é€’**
   - ç½‘çº¢åœ¨æ´»åŠ¨å‘å¸ƒåä¿®æ”¹preferred_courier
   - å¤„ç†ï¼šä»…å½±å“æ–°è®¢å•ï¼Œå·²å­˜åœ¨è®¢å•ä¿æŒåŸå¿«é€’

---

## æˆåŠŸæŒ‡æ ‡ (Success Metrics)

### æ–°å¢æŒ‡æ ‡

- **SM-001**: æ´»åŠ¨ä¿¡æ¯å®Œæ•´åº¦ â‰¥ 90% (åŒ…å«æ ‡é¢˜ã€å¹³å°ã€å‘è´§ä¿¡æ¯)
- **SM-002**: å®šæ—¶å‘å¸ƒåŠŸèƒ½ä½¿ç”¨ç‡ â‰¥ 30%
- **SM-003**: å¯†ç ä¿æŠ¤æ´»åŠ¨å æ¯” â‰¥ 15%
- **SM-004**: æ‰¹é‡ä¸Šæ¶æ•ˆç‡æå‡ï¼šå¹³å‡æ¯ä¸ªç‰©å“ä¸Šæ¶æ—¶é—´ä»30ç§’é™è‡³10ç§’
- **SM-005**: ä¼˜é€‰å¿«é€’å‘½ä¸­ç‡ â‰¥ 80% (è®¢å•ä½¿ç”¨æ´»åŠ¨é¢„è®¾å¿«é€’çš„æ¯”ä¾‹)
- **SM-006**: æ‰¹é‡ç”ŸæˆåŠŸèƒ½ä½¿ç”¨ç‡ â‰¥ 60% (ä½¿ç”¨æ•°é‡>1çš„ä¸Šä¼ æ¯”ä¾‹)

### ä¿®è®¢æŒ‡æ ‡

- **SC-001 ä¿®è®¢**: ç½‘çº¢åˆ›å»ºåŒ…å«5ä»¶ç‰©å“çš„å®Œæ•´æ´»åŠ¨ï¼ˆå«å…ƒæ•°æ®ï¼‰æ—¶é—´ä»3åˆ†é’Ÿä¼˜åŒ–è‡³4åˆ†é’Ÿ
  - ç†ç”±ï¼šå¢åŠ æ´»åŠ¨ä¿¡æ¯å½•å…¥æ­¥éª¤ï¼Œä½†æ‰¹é‡ä¸Šæ¶æé«˜ç‰©å“å¤„ç†æ•ˆç‡

---

## è¿ç§»è®¡åˆ’ (Migration Plan)

### é˜¶æ®µä¸€ï¼šæ•°æ®åº“æ‰©å±•ï¼ˆç¬¬1å‘¨ï¼‰

1. åœ¨ `activities` é›†åˆæ·»åŠ æ–°å­—æ®µï¼ˆè®¾ç½®é»˜è®¤å€¼ï¼‰
2. åœ¨ `items` é›†åˆæ·»åŠ æ‰¹é‡ç›¸å…³å­—æ®µ
3. åˆ›å»ºå¿…è¦çš„æ•°æ®åº“ç´¢å¼•
4. è¿è¡Œè¿ç§»è„šæœ¬ä¸ºç°æœ‰æ•°æ®å¡«å……é»˜è®¤å€¼

```javascript
// è¿ç§»è„šæœ¬ç¤ºä¾‹
const migrateActivities = async () => {
  const activities = await db.collection('activities').get();
  
  for (const activity of activities.data) {
    await db.collection('activities').doc(activity._id).update({
      data: {
        title: activity.title || 'èµ é€æ´»åŠ¨',
        source_platform: 'other',
        is_immediate_publish: true,
        is_password_protected: false,
        total_items_count: 0, // éœ€è¦é‡æ–°è®¡ç®—
        available_items_count: 0,
        view_count: 0,
        access_attempts: 0
      }
    });
  }
};
```

### é˜¶æ®µäºŒï¼šäº‘å‡½æ•°å¼€å‘ï¼ˆç¬¬2å‘¨ï¼‰

1. å®ç° `activities.createWithMetadata`
2. å®ç° `activities.verifyPassword`
3. å®ç° `items.batchUpload`
4. æ›´æ–°ç°æœ‰äº‘å‡½æ•°ä»¥å…¼å®¹æ–°å­—æ®µ
5. ç¼–å†™å•å…ƒæµ‹è¯•

### é˜¶æ®µä¸‰ï¼šå‰ç«¯å¼€å‘ï¼ˆç¬¬3-4å‘¨ï¼‰

1. å¼€å‘ `create-activity-info` é¡µé¢
2. æ”¹é€  `batch-upload-items` é¡µé¢
3. å¼€å‘ `activity-preview` é¡µé¢
4. å®ç°å¯†ç éªŒè¯å¼¹çª—ç»„ä»¶
5. æ›´æ–°è·¯ç”±é…ç½®

### é˜¶æ®µå››ï¼šæµ‹è¯•ä¸å‘å¸ƒï¼ˆç¬¬5å‘¨ï¼‰

1. é›†æˆæµ‹è¯•
2. ç”¨æˆ·ä½“éªŒæµ‹è¯•
3. ç°åº¦å‘å¸ƒï¼ˆ10%ç”¨æˆ·ï¼‰
4. æ”¶é›†åé¦ˆå¹¶ä¼˜åŒ–
5. å…¨é‡å‘å¸ƒ

---

## å…¼å®¹æ€§è€ƒè™‘ (Compatibility)

### å‘åå…¼å®¹

1. **ç°æœ‰æ´»åŠ¨**ï¼šè‡ªåŠ¨å¡«å……é»˜è®¤å€¼ï¼Œæ­£å¸¸å±•ç¤ºå’Œè¿è¡Œ
2. **APIç‰ˆæœ¬**ï¼šä¿ç•™æ—§ç‰ˆ `activities.create` æ¥å£ï¼Œæ ‡è®°ä¸º deprecated
3. **å‰ç«¯é€‚é…**ï¼šæ£€æµ‹æ´»åŠ¨æ˜¯å¦åŒ…å«æ–°å­—æ®µï¼Œå±•ç¤ºå¯¹åº”UI

### æ¸è¿›å¢å¼º

1. æ–°åˆ›å»ºçš„æ´»åŠ¨å¼ºåˆ¶ä½¿ç”¨æ–°æµç¨‹
2. æ—§æ´»åŠ¨æ”¯æŒ"å‡çº§"ï¼Œè¡¥å……å…ƒæ•°æ®
3. æ–°åŠŸèƒ½ï¼ˆå¯†ç ä¿æŠ¤ã€å®šæ—¶å‘å¸ƒï¼‰ä»…å¯¹æ–°æ´»åŠ¨å¼€æ”¾

---

## é£é™©è¯„ä¼° (Risk Assessment)

### æŠ€æœ¯é£é™©

| é£é™©é¡¹ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|--------|------|------|----------|
| æ‰¹é‡ç”Ÿæˆç‰©å“æ€§èƒ½é—®é¢˜ | é«˜ | ä¸­ | é™åˆ¶å•æ¬¡æœ€å¤§100ä»¶ï¼Œåˆ†æ‰¹å¤„ç† |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | é«˜ | ä½ | æå‰å¤‡ä»½ï¼Œç¼–å†™å›æ»šè„šæœ¬ |
| äº‘å‡½æ•°è¶…æ—¶ï¼ˆæ‰¹é‡æ“ä½œï¼‰ | ä¸­ | ä¸­ | å¼‚æ­¥å¤„ç†ï¼Œè¿”å›task_idè½®è¯¢ç»“æœ |

### äº§å“é£é™©

| é£é™©é¡¹ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|--------|------|------|----------|
| æµç¨‹å¤æ‚åº¦å¢åŠ å¯¼è‡´ç”¨æˆ·æµå¤± | ä¸­ | ä¸­ | æä¾›å¼•å¯¼åŠ¨ç”»ï¼Œå…è®¸è·³è¿‡éå¿…å¡«é¡¹ |
| å¯†ç ä¿æŠ¤é™ä½æ´»åŠ¨æ›å…‰ | ä½ | é«˜ | ç»Ÿè®¡æ•°æ®åˆ†æï¼Œæä¾›ä½¿ç”¨å»ºè®® |
| å®šæ—¶å‘å¸ƒåŠŸèƒ½è¢«æ»¥ç”¨ | ä½ | ä½ | é™åˆ¶å•ä¸ªç½‘çº¢å¾…å‘å¸ƒæ´»åŠ¨æ•°é‡ |

---

## å¾…è§£å†³é—®é¢˜ (Open Questions)

1. **Q**: æ‰¹é‡ä¸Šæ¶æ—¶ï¼Œå¦‚æœæŸäº›ç‰©å“AIè¯†åˆ«å¤±è´¥ï¼Œæ˜¯å¦é˜»æ–­æ•´ä¸ªæµç¨‹ï¼Ÿ  
   **A**: ä¸é˜»æ–­ï¼Œå…è®¸æ‰‹åŠ¨é€‰æ‹©åˆ†ç±»åç»§ç»­

2. **Q**: å¯†ç ä¿æŠ¤çš„æ´»åŠ¨æ˜¯å¦è®¡å…¥å…¬å¼€æ´»åŠ¨åˆ—è¡¨ï¼Ÿ  
   **A**: ä¸è®¡å…¥ï¼Œä»…é€šè¿‡ç›´æ¥é“¾æ¥è®¿é—®

3. **Q**: å®šæ—¶å‘å¸ƒåˆ°è¾¾æ—¶é—´åï¼Œæ˜¯å¦è‡ªåŠ¨è½¬ä¸ºactiveçŠ¶æ€ï¼Ÿ  
   **A**: æ˜¯ï¼Œä½¿ç”¨äº‘å‡½æ•°å®šæ—¶è§¦å‘å™¨

4. **Q**: ä¼˜é€‰å¿«é€’æ˜¯å¦å…è®¸ç²‰ä¸ä¿®æ”¹ï¼Ÿ  
   **A**: ç¬¬ä¸€ç‰ˆä¸å…è®¸ï¼Œåç»­å¯è€ƒè™‘åŠ ä»·æ›´æ¢

5. **Q**: æ‰¹é‡ç”Ÿæˆçš„ç‰©å“æ˜¯å¦æ”¯æŒå•ç‹¬ç¼–è¾‘ï¼Ÿ  
   **A**: æ”¯æŒï¼Œæ¯ä¸ªitemç‹¬ç«‹å¯ç¼–è¾‘

---

## é™„å½• (Appendix)

### A. ç›¸å…³æ–‡æ¡£

- [åŸå§‹éœ€æ±‚è§„æ ¼: spec.md](./spec.md)
- [æ•°æ®æ¨¡å‹: data-model.md](./data-model.md)
- [APIå¥‘çº¦: contracts/api-contracts.md](./contracts/api-contracts.md)

### B. åŸå‹è®¾è®¡

ï¼ˆéœ€è¡¥å……åŸå‹å›¾é“¾æ¥æˆ–é™„ä»¶ï¼‰

### C. æŠ€æœ¯å‚è€ƒ

- å¾®ä¿¡äº‘å¼€å‘æ–‡æ¡£: https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html
- äº‘æ•°æ®åº“äº‹åŠ¡: https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/transaction.html

---

## å®¡æ‰¹è®°å½• (Approval)

| è§’è‰² | å§“å | æ—¥æœŸ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|------|------|
| äº§å“ç»ç† | - | - | Pending | - |
| æŠ€æœ¯è´Ÿè´£äºº | - | - | Pending | - |
| UI/UXè®¾è®¡å¸ˆ | - | - | Pending | - |

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. è¯„å®¡æœ¬ææ¡ˆ
2. æ”¶é›†ç›¸å…³æ–¹åé¦ˆ
3. ç»†åŒ–æŠ€æœ¯å®ç°æ–¹æ¡ˆ
4. åˆ›å»ºå¼€å‘ä»»åŠ¡å¹¶æ’æœŸ
