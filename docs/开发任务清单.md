# 🎁 主播赠送平台 - 开发任务清单

> 基于PRD文档生成的完整开发任务列表
> 
> 项目：微信小程序 - 主播闲置赠送平台
> 
> 技术栈：微信小程序 + 腾讯云开发 + 百度AI + 快递100 API

---

## 📊 任务概览

- **总模块数**：14个
- **总任务数**：70+个
- **预计工期**：6周
- **当前状态**：待开始

---

## 🚀 Phase 1: 基础设施搭建（Week 1）

### T1_ENV_SETUP - 【环境配置】配置开发环境和API密钥
**优先级**：🔥 最高 | **状态**：PENDING

#### 子任务：
- [ ] **T1_1_WECHAT_CONFIG** - 配置微信小程序AppID和Secret到云函数环境变量
  ```
  WECHAT_APPID=wx28fe6d19a46e6327
  WECHAT_SECRET=789b87feaa1bc64f42489529d64b04d6
  ```

- [ ] **T1_2_BAIDU_AI_CONFIG** - 配置百度AI API密钥到云函数环境变量
  ```
  BAIDU_API_KEY=Ynk0D3FhSZO5UVxcLrMMO60R
  BAIDU_SECRET_KEY=bTHzNmCKAVE8dKSFGH2HNHg3A4sHCEMA
  ```

- [ ] **T1_3_EXPRESS_CONFIG** - 配置快递100 API密钥到云函数环境变量
  ```
  KUAIDI100_KEY=EZWROLVn8912
  KUAIDI100_SECRET=b18729a888c54001b9d9f9a7aa6cbce7
  ```

---

### T2_DATABASE_INIT - 【数据库初始化】创建云数据库集合和索引
**优先级**：🔥 最高 | **状态**：PENDING

#### 子任务：
- [ ] **T2_1_CREATE_USERS** - 创建users集合，设置openid索引
- [ ] **T2_2_CREATE_ACTIVITIES** - 创建activities集合，设置influencer_id和status索引
- [ ] **T2_3_CREATE_ITEMS** - 创建items集合，设置activity_id和status索引
- [ ] **T2_4_CREATE_ORDERS** - 创建orders集合，设置activity_id、fan_wechat_openid和payment_status索引
- [ ] **T2_5_CREATE_PAYMENTS** - 创建payments集合，设置order_id和transaction_id索引
- [ ] **T2_6_CREATE_SHIPPING_INFO** - 创建shipping_info集合，设置order_id索引
- [ ] **T2_7_CREATE_PASSWORD_ERRORS** - 创建password_errors集合，设置activity_id和user_openid复合索引

**数据库设计要点**：
- 使用MongoDB文档型存储
- 所有集合需要created_at和updated_at字段
- 关键字段建立索引提升查询性能

---

### T3_AUTH_MODULE - 【用户认证模块】实现用户注册登录功能
**优先级**：🔥 最高 | **状态**：PENDING

#### 子任务：
- [ ] **T3_1_AUTH_FUNCTION** - 创建auth云函数（微信登录、手机号绑定、用户信息更新）
  - 文件位置：`cloudfunctions/auth/index.js`
  - 功能：微信授权登录、获取用户信息、手机号绑定、身份证验证

- [ ] **T3_2_REGISTER_PAGE** - 实现register页面（身份证信息填写、发货地址管理）
  - 页面路径：`miniprogram/pages/register/`
  - 功能：身份证信息填写（物流实名制）、多地址管理

- [ ] **T3_3_PROFILE_PAGE** - 完善profile页面（用户信息展示、多地址管理）
  - 页面路径：`miniprogram/pages/profile/`
  - 功能：用户信息展示、地址列表、设置默认地址

**关键点**：
- 支持多个发货地址
- 身份证信息用于物流实名制
- 地址可设置默认

---

## 🔧 Phase 2: 核心功能开发（Week 2-3）

### T4_AI_RECOGNITION - 【AI识别模块】实现百度AI物品识别功能
**优先级**：🔥 高 | **状态**：PENDING

#### 子任务：
- [ ] **T4_1_AI_FUNCTION** - 创建ai-recognition云函数（调用百度AI通用物体识别）
  - 文件位置：`cloudfunctions/ai-recognition/index.js`
  - API：百度AI通用物体和场景识别
  - 返回：keyword、score、root字段

- [ ] **T4_2_CATEGORY_MAPPING** - 实现百度AI结果到系统8标签的映射逻辑
  - 系统标签：电子产品、服装、图书、化妆品、玩具、食品、家居、其他
  - 映射规则：keyword和root字段综合判断

- [ ] **T4_3_WEIGHT_ESTIMATION** - 实现AI重量估算逻辑（成功用预设值，失败用基础报价+2元）
  - 预设重量：根据分类0.2kg-0.6kg
  - 失败处理：使用基础报价+2元

**AI识别流程**：
```
图片上传 → base64编码 → 调用百度AI → 解析结果 → 映射标签 → 估算重量
```

---

### T5_ACTIVITY_MODULE - 【活动管理模块】实现活动创建和管理功能
**优先级**：🔥 高 | **状态**：PENDING

#### 子任务：
- [ ] **T5_1_ACTIVITIES_FUNCTION** - 创建activities云函数（创建、更新、查询、删除活动）
  - 文件位置：`cloudfunctions/activities/index.js`
  - 功能：CRUD操作、状态管理

- [ ] **T5_2_CREATE_ACTIVITY_PAGE** - 实现create-activity-info页面（活动基本信息填写）
  - 页面路径：`miniprogram/pages/create-activity-info/`
  - 字段：开播平台、开播时间、密码设置、快递指定、数量限制

- [ ] **T5_3_BATCH_UPLOAD_PAGE** - 实现batch-upload-items页面（批量上传物品照片）
  - 页面路径：`miniprogram/pages/batch-upload-items/`
  - 功能：批量选择照片、AI识别、物品编辑

- [ ] **T5_4_ITEM_NUMBER_LOGIC** - 实现5位数字编号自动生成逻辑（活动内自增00001-99999）
  - 范围：00001-99999
  - 规则：活动内唯一、自增、可手动修改

- [ ] **T5_5_ADDRESS_SNAPSHOT** - 实现发货地址快照功能（活动创建时保存地址副本）
  - 快照时机：活动创建时
  - 存储位置：activities.snapshot_shipping_address
  - 目的：地址修改不影响历史活动

- [ ] **T5_6_QR_CODE_GEN** - 实现小程序码生成功能
  - API：微信小程序码生成接口
  - 存储：云存储
  - 用途：分享到抖音直播间

- [ ] **T5_7_MY_ACTIVITIES_PAGE** - 实现my-activities页面（活动列表展示和管理）
  - 页面路径：`miniprogram/pages/my-activities/`
  - 功能：活动列表、状态筛选、活动管理

---

### T6_ITEM_MODULE - 【物品管理模块】实现物品上传和管理功能
**优先级**：🔥 高 | **状态**：PENDING

#### 子任务：
- [ ] **T6_1_ITEMS_FUNCTION** - 创建items云函数（创建、更新、查询、删除物品）
  - 文件位置：`cloudfunctions/items/index.js`
  - 功能：物品CRUD、批量操作

- [ ] **T6_2_IMAGE_UPLOAD** - 实现图片上传到云存储功能（压缩、缩略图生成）
  - 压缩：质量80%
  - 缩略图：宽度200px
  - CDN加速

- [ ] **T6_3_STOCK_MANAGEMENT** - 实现库存管理逻辑（扣减、释放、库存提示）
  - 扣减：下单时
  - 释放：订单取消/超时
  - 提示：库存不足显示"仅剩N个"

---

### T7_EXPRESS_MODULE - 【快递对接模块】实现快递100 API对接
**优先级**：🔥 高 | **状态**：PENDING

#### 子任务：
- [ ] **T7_1_EXPRESS_QUERY_FUNCTION** - 创建express-query-price云函数（运费查询）
  - 文件位置：`cloudfunctions/express-query-price/index.js`
  - API：快递100运费查询接口
  - 签名：MD5(param + t + key + secret)

- [ ] **T7_2_EXPRESS_ORDER_FUNCTION** - 创建express-create-order云函数（快递下单、生成运单号）
  - 文件位置：`cloudfunctions/express-create-order/index.js`
  - API：快递100下单接口
  - 返回：运单号、电子面单URL

- [ ] **T7_3_EXPRESS_TRACK_FUNCTION** - 创建express-track云函数（物流跟踪查询）
  - 文件位置：`cloudfunctions/express-track/index.js`
  - API：快递100物流查询接口
  - 返回：物流轨迹、当前状态

- [ ] **T7_4_MULTI_ITEM_PRICING** - 实现多物品订单运费计算逻辑（多次API调用取最高价）
  - 逻辑：分别查询每个物品运费，取最高价作为基础运费
  - 公式：基础运费 = MAX(物品1运费, 物品2运费, ..., 物品N运费)

- [ ] **T7_5_LOGISTICS_TIMER** - 创建定时任务（每6小时查询物流，签收后停止）
  - 定时器：云函数定时触发器（cron: 0 */6 * * *）
  - 逻辑：查询已发货未签收订单，更新物流信息
  - 停止：签收后不再查询

**快递API关键点**：
- 使用快递100作为主要方案
- MD5签名算法
- 官方报价 vs 协议价（差价=平台利润）

---

## 💰 Phase 3: 交易流程开发（Week 4）

### T8_FAN_MODULE - 【粉丝端模块】实现粉丝浏览和领取功能
**优先级**：🔥 高 | **状态**：PENDING

#### 子任务：
- [ ] **T8_1_ACTIVITY_DETAIL_PAGE** - 完善activity-detail页面（活动详情、物品列表展示）
  - 页面路径：`miniprogram/pages/activity-detail/`
  - 功能：活动信息、物品网格展示、快递选择

- [ ] **T8_2_PASSWORD_VERIFY** - 实现活动密码验证功能（5次错误限制）
  - 验证时机：进入活动页时
  - 错误限制：5次
  - 记录：password_errors集合

- [ ] **T8_3_CLAIM_ITEM_PAGE** - 实现claim-item页面（物品领取、地址填写）
  - 页面路径：`miniprogram/pages/claim-item/`
  - 功能：物品详情、数量选择、收货地址、费用明细

- [ ] **T8_4_QUANTITY_LIMIT** - 实现每人限领2个逻辑
  - 限制：同一物品每人最多2个
  - 检查：下单前验证
  - 存储：订单记录

- [ ] **T8_5_EXPLORE_PAGE** - 实现explore页面（活动发现、筛选）
  - 页面路径：`miniprogram/pages/explore/`
  - 功能：活动列表、分类筛选、搜索

---

### T9_ORDER_MODULE - 【订单管理模块】实现订单创建和管理功能
**优先级**：🔥 高 | **状态**：PENDING

#### 子任务：
- [ ] **T9_1_ORDERS_FUNCTION** - 创建orders云函数（创建订单、查询订单、更新状态）
  - 文件位置：`cloudfunctions/orders/index.js`
  - 功能：订单CRUD、状态流转

- [ ] **T9_2_PRICE_CALCULATION** - 实现订单价格计算逻辑（官方报价+包装费+服务费5%）
  - **单物品公式**：
    ```
    官方报价 = 快递100 API查询
    包装费 = 2元/个
    平台服务费 = (官方报价 + 包装费) * 5%
    粉丝支付 = 官方报价 + 包装费 + 平台服务费
    ```
  - **多物品公式**：
    ```
    基础运费 = MAX(各物品官方报价)
    包装费 = 物品数量 * 2元
    平台服务费 = (基础运费 + 包装费) * 5%
    粉丝支付 = 基础运费 + 包装费 + 平台服务费
    ```

- [ ] **T9_3_ORDER_TIMEOUT** - 实现订单超时逻辑（15分钟支付超时自动取消）
  - 超时时间：15分钟
  - 处理：自动取消订单、释放库存
  - 实现：云函数定时触发器

- [ ] **T9_4_MY_ORDERS_PAGE** - 实现my-orders页面（订单列表、状态筛选）
  - 页面路径：`miniprogram/pages/my-orders/`
  - 功能：订单列表、状态筛选、订单详情跳转

- [ ] **T9_5_ORDER_DETAIL_PAGE** - 完善order-detail页面（订单详情、物流信息）
  - 页面路径：`miniprogram/pages/order-detail/`
  - 功能：订单信息、物品列表、物流跟踪、费用明细

**订单状态流转**：
```
pending（待支付）→ paid（已支付）→ processing（处理中）→ shipped（已发货）→ completed（已完成）
                ↓
             cancelled（已取消）
```

---

### T10_PAYMENT_MODULE - 【支付模块】实现微信支付功能
**优先级**：🔥 高 | **状态**：PENDING

#### 子任务：
- [ ] **T10_1_PAYMENTS_FUNCTION** - 创建payments云函数（发起支付、支付回调、退款）
  - 文件位置：`cloudfunctions/payments/index.js`
  - 功能：统一下单、支付回调、退款处理

- [ ] **T10_2_PAYMENT_PAGE** - 完善payment页面（支付金额展示、调起微信支付）
  - 页面路径：`miniprogram/pages/payment/`
  - 功能：金额展示、调起支付、支付结果处理

- [ ] **T10_3_REFUND_LOGIC** - 实现退款逻辑（支付后未发货可退款）
  - 退款规则：
    - 支付后未发货：可退款（全额）
    - 已发货：不支持退款
    - 多物品订单：不支持部分退款

**支付流程**：
```
创建订单 → 发起支付 → 调起微信支付 → 支付成功 → 回调处理 → 更新订单状态 → 自动下单快递
```

---

### T11_SHIPPING_MODULE - 【发货模块】实现发货和物流跟踪功能
**优先级**：🔥 高 | **状态**：PENDING

#### 子任务：
- [ ] **T11_1_SHIPPING_FUNCTION** - 创建shipping云函数（发货处理、物流信息更新）
  - 文件位置：`cloudfunctions/shipping/index.js`
  - 功能：发货处理、物流同步

- [ ] **T11_2_AUTO_ORDER_EXPRESS** - 实现支付成功后自动调用快递API下单
  - 触发：支付成功回调
  - 流程：调用快递API → 获取运单号 → 保存到shipping_info
  - 自动化：无需主播手动操作

- [ ] **T11_3_SHIPPING_LABEL_PAGE** - 实现shipping-label页面（电子面单展示）
  - 页面路径：`miniprogram/pages/shipping-label/`
  - 功能：展示电子面单、运单号复制

- [ ] **T11_4_SHIPPING_REMINDER** - 实现48小时发货提醒功能
  - 提醒时机：支付后48小时未发货
  - 方式：模板消息或服务通知

---

## 🎁 Phase 4: 增值功能开发（Week 5）

### T12_SHARING_MODULE - 【晒单模块】实现晒单功能
**优先级**：🔶 中 | **状态**：PENDING

#### 子任务：
- [ ] **T12_1_SHARE_ITEM_PAGE** - 实现share-item页面（上传晒单照片、文字）
  - 页面路径：`miniprogram/pages/share-item/`
  - 功能：照片上传（最多9张）、文字描述

- [ ] **T12_2_SHARING_AREA_PAGE** - 实现sharing-area页面（晒单列表展示）
  - 页面路径：`miniprogram/pages/sharing-area/`
  - 功能：晒单列表、点赞、评论

- [ ] **T12_3_DELETE_MALICIOUS** - 实现恶意内容删除功能（主播权限）
  - 权限：仅主播可删除
  - 功能：删除恶意晒单

---

### T13_ANALYTICS_MODULE - 【数据统计模块】实现数据统计功能
**优先级**：🔶 中 | **状态**：PENDING

#### 子任务：
- [ ] **T13_1_ANALYTICS_FUNCTION** - 创建analytics云函数（统计总赠送量、活动次数、粉丝数）
  - 文件位置：`cloudfunctions/analytics/index.js`
  - 统计维度：
    - 总赠送物品数量
    - 活动次数
    - 累计粉丝数
    - 平台利润

- [ ] **T13_2_STATS_DISPLAY** - 在profile页面集成数据统计展示
  - 展示位置：个人中心页面
  - 数据：赠送量、活动次数、粉丝数

---

## 🧪 Phase 5: 测试优化（Week 6）

### T14_TESTING - 【测试验证】功能测试和优化
**优先级**：🔶 中 | **状态**：PENDING

#### 子任务：
- [ ] **T14_1_UNIT_TEST** - 编写核心云函数单元测试
  - 测试框架：Jest
  - 覆盖率目标：80%+
  - 重点模块：支付、订单、快递

- [ ] **T14_2_INTEGRATION_TEST** - 进行完整业务流程测试
  - 测试流程：
    1. 主播注册 → 创建活动 → 上传物品
    2. 粉丝浏览 → 领取 → 支付
    3. 自动下单 → 发货 → 物流跟踪
    4. 签收 → 晒单

- [ ] **T14_3_PERFORMANCE_OPT** - 性能优化（图片加载、云函数响应时间）
  - 图片优化：懒加载、CDN加速
  - 云函数：冷启动优化、缓存策略
  - 数据库：索引优化、查询优化

---

## 📈 关键指标

### 性能要求
- 云函数响应时间：< 500ms
- 图片加载时间：< 2s
- 页面渲染时间：< 1s

### 业务指标
- 支付成功率：> 95%
- 自动下单成功率：> 98%
- 物流查询准确率：> 99%

---

## 🔑 关键技术点

### 1. 多物品订单运费计算
```javascript
// 分别查询每个物品运费，取最高价
const prices = await Promise.all(
  items.map(item => queryExpressPrice(item))
);
const baseShipping = Math.max(...prices);
```

### 2. 订单超时自动取消
```javascript
// 云函数定时触发器（每分钟检查一次）
// cron: 0 * * * * * *
const expiredOrders = await db.collection('orders')
  .where({
    payment_status: 'pending',
    payment_deadline: db.command.lt(new Date())
  })
  .get();
```

### 3. 物流定时查询
```javascript
// 云函数定时触发器（每6小时）
// cron: 0 */6 * * *
const shippedOrders = await db.collection('orders')
  .where({
    order_status: 'shipped',
    logistics_status: db.command.neq('signed')
  })
  .get();
```

### 4. 价格计算公式
```javascript
// 单物品
const total = officialPrice + packagingFee + serviceFee;
const serviceFee = (officialPrice + packagingFee) * 0.05;

// 多物品
const baseShipping = Math.max(...itemPrices);
const packagingFee = itemCount * 2;
const serviceFee = (baseShipping + packagingFee) * 0.05;
```

---

## 📝 开发规范

### 代码规范
- 使用ESLint + Prettier
- 遵循微信小程序开发规范
- 云函数使用async/await
- 错误处理使用try-catch

### Git提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
test: 测试相关
chore: 构建/工具相关
```

### 分支策略
- `main`: 生产环境
- `dev`: 开发环境
- `feature/*`: 功能分支
- `fix/*`: 修复分支

---

## ⚠️ 风险提示

### 技术风险
1. **百度AI识别准确率**：可能需要人工辅助修正
2. **快递API稳定性**：需要错误重试机制
3. **支付回调延迟**：需要轮询查询支付状态

### 业务风险
1. **运费差价**：需要定期审核协议价
2. **库存超卖**：需要分布式锁
3. **恶意下单**：需要风控策略

---

## 📞 支持资源

### API文档
- 微信小程序：https://developers.weixin.qq.com/miniprogram/dev/
- 腾讯云开发：https://cloud.tencent.com/document/product/876
- 百度AI：https://ai.baidu.com/ai-doc/IMAGERECOGNITION/
- 快递100：https://api.kuaidi100.com/document/

### 技术支持
- 微信开放社区
- 腾讯云工单
- GitHub Issues

---

**最后更新时间**：2025-11-10
**文档版本**：v1.0
**维护者**：开发团队
