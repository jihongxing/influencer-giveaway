# 数据库初始化指南

## 问题分析

小程序首页出现 `Cannot read properties of undefined (reading 'page')` 错误的主要原因是：**微信云开发环境中缺少必要的数据库集合**。

当云函数尝试访问不存在的集合时，会返回错误，导致前端无法正确获取分页信息（pagination对象），从而出现"Cannot read properties of undefined (reading 'page')"错误。

## 解决方案

按照以下步骤操作，初始化所有必需的数据库集合：

### 步骤1：部署db-init云函数

1. 在微信开发者工具中，右键点击 `cloudfunctions/db-init` 目录
2. 选择 **上传并部署：云端安装依赖**
3. 等待部署完成（可能需要1-2分钟）

### 步骤2：运行数据库初始化

1. 部署完成后，右键点击 `cloudfunctions/db-init` 目录
2. 选择 **调用云函数**
3. 在弹出的对话框中直接点击 **确定**（不需要额外参数）
4. 等待函数执行完成

### 步骤3：检查初始化结果

1. 查看调用结果输出
2. 确认所有集合都已成功创建：
   - users
   - activities
   - items
   - orders
   - shipping
   - sharing_posts
   - external_activities

### 步骤4：部署其他必要的云函数

同样的方法部署其他关键云函数：

1. 部署 auth 云函数
2. 部署 activities 云函数
3. 部署 items 云函数
4. 部署 orders 云函数

### 步骤5：重启小程序

1. 关闭并重新打开微信开发者工具
2. 清除缓存（点击右上角"详情"→"本地设置"→"清除缓存"）
3. 重新编译运行小程序

## 验证修复

1. 打开控制台，检查是否还有错误信息
2. 首页应该能正常显示活动列表（如果有数据的话）
3. 分页功能应该正常工作

## 注意事项

1. 确保你的云开发环境ID是 `cloud1-8gezjcq432191d0d`（已在app.js中配置）
2. 首次运行时，数据库中没有数据是正常的，不会影响功能
3. 如果仍有问题，请检查云函数调用日志，查看具体错误信息

## 其他建议

1. 在云开发控制台中查看创建的集合
2. 考虑配置适当的数据库权限规则，参考 `docs/cloud-database-setup.md`
3. 如果需要测试数据，可以手动添加一些示例活动