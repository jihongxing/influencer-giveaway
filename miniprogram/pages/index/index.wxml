<!--pages/index/index.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="header">
    <view class="user-section" wx:if="{{isLoggedIn && userInfo}}">
      <image
        class="user-avatar"
        src="{{userInfo.avatar_url || '/images/default-avatar.png'}}"
        mode="aspectFill"
      ></image>
      <view class="user-info">
        <text class="greeting">ä½ å¥½ï¼Œ{{userInfo.nickname || 'ç”¨æˆ·'}}</text>
      </view>
    </view>
    <view class="login-prompt" wx:else>
      <text class="greeting">æ¬¢è¿ä½¿ç”¨é—²ç½®ç‰©å“èµ é€å¹³å°</text>
      <text class="login-btn" bindtap="onLogin">ç™»å½•</text>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-bar" bindtap="onSearch">
    <text class="search-icon">ğŸ”</text>
    <text class="search-placeholder">æœç´¢æ´»åŠ¨æˆ–ç”¨æˆ·</text>
  </view>

  <!-- åˆ†ç±»å¯¼èˆª -->
  <view class="categories">
    <view
      class="category-item {{category === '' ? 'active' : ''}}"
      data-category=""
      bindtap="onCategoryChange"
    >
      å…¨éƒ¨
    </view>
    <view
      class="category-item {{category === 'clothing' ? 'active' : ''}}"
      data-category="clothing"
      bindtap="onCategoryChange"
    >
      æœè£…
    </view>
    <view
      class="category-item {{category === 'books' ? 'active' : ''}}"
      data-category="books"
      bindtap="onCategoryChange"
    >
      ä¹¦ç±
    </view>
    <view
      class="category-item {{category === 'cosmetics' ? 'active' : ''}}"
      data-category="cosmetics"
      bindtap="onCategoryChange"
    >
      ç¾å¦†
    </view>
    <view
      class="category-item {{category === 'other' ? 'active' : ''}}"
      data-category="other"
      bindtap="onCategoryChange"
    >
      å…¶ä»–
    </view>
  </view>

  <!-- æ´»åŠ¨åˆ—è¡¨ -->
  <view class="activities-section">
    <view class="section-title">æ¨èæ´»åŠ¨</view>
    <view class="activities-list" wx:if="{{!loading && activities.length > 0}}">
      <view
        class="activity-card"
        wx:for="{{activities}}"
        wx:key="activity_id"
        data-id="{{item.activity_id}}"
        data-link-id="{{item.shareable_link}}"
        bindtap="onActivityTap"
      >
        <!-- æ´»åŠ¨å°é¢ -->
        <view class="activity-cover" wx:if="{{item.items && item.items.length > 0}}">
          <image
            class="cover-image"
            src="{{item.items[0].photo_urls[0]}}"
            mode="aspectFill"
            lazy-load="{{true}}"
            binderror="handleImageError"
            data-file-id="{{item.items[0].photo_urls[0]}}"
            data-type="item"
            data-index="{{index}}"
            data-item-index="0"
          ></image>
          <view class="cover-overlay">
            <text class="items-count">{{item.items.length}}ä»¶</text>
          </view>
        </view>

        <!-- æ´»åŠ¨ä¿¡æ¯ -->
        <view class="activity-info">
          <view class="activity-header">
            <view class="user-info">
              <image
                class="user-avatar"
                src="{{item.influencer.avatar_url || '/images/default-avatar.png'}}"
                mode="aspectFill"
                binderror="handleImageError"
                data-file-id="{{item.influencer.avatar_url}}"
                data-type="avatar"
                data-index="{{index}}"
              ></image>
              <text class="user-nickname">{{item.influencer.nickname || 'ç”¨æˆ·'}}</text>
            </view>
          </view>

          <view class="activity-items">
            <view
              class="item-preview"
              wx:for="{{item.items}}"
              wx:for-item="item"
              wx:key="item_id"
              wx:for-index="itemIndex"
              wx:if="{{itemIndex < 2}}"
            >
              <text class="item-name">{{item.label || 'æœªå‘½åç‰©å“'}}</text>
              <text class="item-shipping">Â¥{{item.shipping_cost_estimate}}</text>
            </view>
          </view>

          <view class="activity-footer">
            <text class="activity-time">{{item.created_at}}</text>
            <text class="view-detail">æŸ¥çœ‹ â†’</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading" wx:if="{{loading && activities.length === 0}}">
      <loading loading="{{true}}" message="åŠ è½½ä¸­..."></loading>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty" wx:if="{{!loading && activities.length === 0 && !error}}">
      <text class="empty-text">æš‚æ— æ´»åŠ¨</text>
      <text class="empty-desc">è¯•è¯•è°ƒæ•´åˆ†ç±»æˆ–ç¨åå†æ¥</text>
    </view>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <error-message wx:if="{{!loading && error}}" error="{{error}}" show="{{true}}" bindretry="loadActivities"></error-message>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="loading-more" wx:if="{{loading && activities.length > 0}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <view class="no-more" wx:if="{{!hasMore && activities.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </view>
</view>
