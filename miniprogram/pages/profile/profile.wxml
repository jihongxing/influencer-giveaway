<!--pages/profile/profile.wxml-->
<view class="container">
  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view class="login-prompt" wx:if="{{!isLoggedIn && !loading}}">
    <view class="login-content">
      <text class="login-title">ç™»å½•åæŸ¥çœ‹ä¸ªäººä¸­å¿ƒ</text>
      <text class="login-desc">ç™»å½•åå¯ä»¥ç®¡ç†æ‚¨çš„æ´»åŠ¨å’Œè®¢å•</text>
      <button class="login-btn" type="primary" bindtap="onLogin">ç«‹å³ç™»å½•</button>
    </view>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view class="profile-content" wx:if="{{isLoggedIn}}">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <view class="user-section">
      <view class="user-header">
        <image
          class="user-avatar"
          src="{{userInfo.avatar_url || '/images/default-avatar.png'}}"
          mode="aspectFill"
        ></image>
        <view class="user-info">
          <text class="user-nickname">{{userInfo.nickname || 'æœªè®¾ç½®æ˜µç§°'}}</text>
          <text class="user-phone">{{userInfo.phone_number || 'æœªç»‘å®šæ‰‹æœºå·'}}</text>
        </view>
        <view class="edit-btn" bindtap="onEditProfile">
          <text>ç¼–è¾‘</text>
        </view>
      </view>
      
      <!-- ç”¨æˆ·ä¿¡æ¯å®Œå–„æç¤º -->
      <view class="info-completion-section">
        <view wx:if="{{missingInfo.basicInfo}}" class="info-item missing">
          <text class="info-title">åŸºæœ¬ä¿¡æ¯</text>
          <text class="info-status">æœªå®Œå–„</text>
          <button class="action-btn primary" bindtap="getUserBasicInfo">è·å–æ˜µç§°å’Œå¤´åƒ</button>
        </view>
        
        <view wx:if="{{missingInfo.phoneNumber}}" class="info-item missing">
          <text class="info-title">æ‰‹æœºå·</text>
          <text class="info-status">æœªç»‘å®š</text>
          <button class="action-btn primary" open-type="getPhoneNumber" bindgetphonenumber="getUserPhoneNumber" disabled="{{updating}}">
            {{updating ? 'è·å–ä¸­...' : 'è·å–æ‰‹æœºå·'}}
          </button>
        </view>
        
        <view wx:if="{{missingInfo.shippingAddress}}" class="info-item missing">
          <text class="info-title">æ”¶è´§åœ°å€</text>
          <text class="info-status">æœªè®¾ç½®</text>
          <button class="action-btn primary" bindtap="chooseShippingAddress">é€‰æ‹©æ”¶è´§åœ°å€</button>
        </view>
        
        <view wx:if="{{!missingInfo.basicInfo && !missingInfo.phoneNumber && !missingInfo.shippingAddress}}" class="info-item completed">
          <text class="info-title">ç”¨æˆ·ä¿¡æ¯</text>
          <text class="info-status success">å…¨éƒ¨å®Œå–„</text>
          <text class="success-icon">âœ“</text>
        </view>
      </view>

      <!-- ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ -->
      <view class="stats-section">
        <view class="stat-item">
          <text class="stat-value">{{stats.activitiesCount}}</text>
          <text class="stat-label">æ´»åŠ¨</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{stats.ordersCount}}</text>
          <text class="stat-label">è®¢å•</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{stats.itemsSent}}</text>
          <text class="stat-label">å·²é€å‡º</text>
        </view>
      </view>
    </view>

    <!-- æˆ‘çš„æ´»åŠ¨ -->
    <view class="section">
      <view class="section-header">
        <text class="section-title">æˆ‘çš„æ´»åŠ¨</text>
        <text class="section-more" bindtap="onViewAllActivities">æŸ¥çœ‹å…¨éƒ¨ â†’</text>
      </view>

      <view class="activities-list" wx:if="{{recentActivities.length > 0}}">
        <view
          class="activity-card"
          wx:for="{{recentActivities}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="onActivityTap"
        >
          <view class="activity-header">
            <text class="activity-status status-{{item.status}}">
              {{item.status === 'active' ? 'è¿›è¡Œä¸­' : item.status === 'draft' ? 'è‰ç¨¿' : 'å·²å®Œæˆ'}}
            </text>
            <text class="activity-date">{{item.created_at}}</text>
          </view>
          <view class="activity-info">
            <text class="items-count">ç‰©å“æ•°é‡ï¼š{{item.items_count || 0}}</text>
          </view>
        </view>
      </view>

      <view class="empty-section" wx:if="{{recentActivities.length === 0}}">
        <text class="empty-text">æš‚æ— æ´»åŠ¨</text>
        <button class="create-btn" bindtap="onCreateActivity">åˆ›å»ºæ´»åŠ¨</button>
      </view>
    </view>

    <!-- æˆ‘çš„è®¢å• -->
    <view class="section">
      <view class="section-header">
        <text class="section-title">æˆ‘çš„è®¢å•</text>
        <text class="section-more" bindtap="onViewAllOrders">æŸ¥çœ‹å…¨éƒ¨ â†’</text>
      </view>

      <view class="orders-list" wx:if="{{recentOrders.length > 0}}">
        <view
          class="order-card"
          wx:for="{{recentOrders}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="onOrderTap"
        >
          <view class="order-header">
            <text class="order-status">{{item.statusText || item.order_status}}</text>
            <text class="order-amount">Â¥{{item.total_amount}}</text>
          </view>
          <view class="order-info">
            <text class="order-item">{{item.itemLabel || item.item_label || 'ç‰©å“'}}</text>
            <text class="order-time">{{item.created_at}}</text>
          </view>
        </view>
      </view>

      <view class="empty-section" wx:if="{{recentOrders.length === 0}}">
        <text class="empty-text">æš‚æ— è®¢å•</text>
      </view>
    </view>

    <!-- å…¶ä»–åŠŸèƒ½ -->
    <view class="section">
      <view class="menu-list">
        <view class="menu-item" bindtap="onSettings">
          <text class="menu-icon">âš™ï¸</text>
          <text class="menu-text">è®¾ç½®</text>
          <text class="menu-arrow">â†’</text>
        </view>
        <view class="menu-item" bindtap="onHelp">
          <text class="menu-icon">â“</text>
          <text class="menu-text">å¸®åŠ©ä¸­å¿ƒ</text>
          <text class="menu-arrow">â†’</text>
        </view>
        <view class="menu-item logout" bindtap="onLogout">
          <text class="menu-icon">ğŸšº</text>
          <text class="menu-text">é€€å‡ºç™»å½•</text>
          <text class="menu-arrow">â†’</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading" wx:if="{{loading}}">
    <loading loading="{{true}}" message="åŠ è½½ä¸­..."></loading>
  </view>
</view>

