<!--pages/activity-detail/activity-detail.wxml-->
<view class="container">
  <!-- åŠ è½½ä¸­ -->
  <loading wx:if="{{loading}}" loading="{{true}}" message="åŠ è½½ä¸­..." fullscreen="{{true}}"></loading>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <error-message wx:if="{{!loading && error}}" error="{{error}}" show="{{true}}" bindretry="loadActivityData"></error-message>

  <!-- æ´»åŠ¨å†…å®¹ -->
  <view class="activity-content" wx:if="{{!loading && !error && activity}}">
    <!-- æ´»åŠ¨å¤´éƒ¨å¡ç‰‡ -->
    <view class="header-card">
      <!-- ç”¨æˆ·ä¿¡æ¯åŒº -->
      <view class="user-section">
        <image
          class="user-avatar"
          src="{{activity.influencer.avatar_url || '/images/default-avatar.png'}}"
          mode="aspectFill"
          binderror="handleImageError"
          data-file-id="{{activity.influencer.avatar_url}}"
          data-type="avatar"
        ></image>
        <view class="user-info">
          <view class="user-nickname">{{activity.influencer.nickname || 'ç”¨æˆ·'}}</view>
          <view class="activity-time">{{activity.created_at}}</view>
        </view>
        <view class="status-badge status-{{activity.status}}">
          {{activity.status === 'active' ? 'è¿›è¡Œä¸­' : activity.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²å–æ¶ˆ'}}
        </view>
      </view>

      <!-- æ´»åŠ¨æ ‡é¢˜å’Œæè¿° -->
      <view class="title-section">
        <view class="activity-title">{{activity.title || 'æ— æ ‡é¢˜'}}</view>
        <view class="activity-description" wx:if="{{activity.description}}">
          {{activity.description}}
        </view>
      </view>

      <!-- ç»Ÿè®¡æ•°æ® -->
      <view class="stats-row">
        <view class="stat-box">
          <view class="stat-number">{{activity.total_items_count || items.length}}</view>
          <view class="stat-label">æ€»ç‰©å“</view>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-box">
          <view class="stat-number available">{{activity.available_items_count !== undefined ? activity.available_items_count : items.length}}</view>
          <view class="stat-label">å¯é¢†å–</view>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-box" wx:if="{{isOwner}}">
          <view class="stat-number claimed">{{claimedItemsCount}}</view>
          <view class="stat-label">å·²é¢†å–</view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’®ï¼ˆä»…åˆ›å»ºè€…å¯è§ï¼‰ -->
    <view class="action-section" wx:if="{{isOwner}}">
      <button class="action-btn primary" bindtap="onShare">
        <text class="btn-icon">ğŸ”—</text>
        <text class="btn-text">åˆ†äº«æ´»åŠ¨</text>
      </button>
      <button class="action-btn secondary" bindtap="onScanQRCode">
        <text class="btn-icon">ğŸ“·</text>
        <text class="btn-text">æ‰«ç åŒ¹é…</text>
      </button>
      <button class="action-btn danger" bindtap="onCancelActivity" wx:if="{{activity.status === 'active'}}">
        <text class="btn-icon">âŒ</text>
        <text class="btn-text">å–æ¶ˆæ´»åŠ¨</text>
      </button>
    </view>

    <!-- ç‰©å“åˆ—è¡¨ -->
    <view class="items-section">
      <view class="section-header">
        <view class="section-title">ğŸ ç‰©å“åˆ—è¡¨</view>
        <view class="section-subtitle">{{items.length}} ä»¶ç‰©å“</view>
      </view>
      <view class="items-grid">
        <view
          class="item-card"
          wx:for="{{items}}"
          wx:key="item_id"
          data-id="{{item.item_id}}"
          bindtap="onItemTap"
        >
          <view class="item-image-wrapper">
            <image
              class="item-image"
              src="{{item.photo_urls && item.photo_urls.length > 0 ? item.photo_urls[0] : '/images/default-item.png'}}"
              mode="aspectFill"
              lazy-load="{{true}}"
              binderror="handleImageError"
              data-file-id="{{item.photo_urls && item.photo_urls.length > 0 ? item.photo_urls[0] : ''}}"
              data-type="item"
              data-index="{{index}}"
            ></image>
            <view class="item-badge {{item.remaining_quantity > 0 ? 'available' : 'claimed'}}">
              {{item.remaining_quantity > 0 ? 'å¯é¢†å–' : 'å·²é¢†å®Œ'}}
            </view>
          </view>
          <view class="item-content">
            <view class="item-name">{{item.label || 'æœªå‘½åç‰©å“'}}</view>
            <view class="item-meta">
              <view class="item-category">ğŸ·ï¸ {{item.category_label || item.category || 'å…¶ä»–'}}</view>
              <view class="item-stock" wx:if="{{item.remaining_quantity !== undefined}}">
                å‰©ä½™ {{item.remaining_quantity}}/{{item.marker_quantity}}
              </view>
            </view>
            <view class="item-bottom">
              <view class="item-price">Â¥{{item.shipping_cost_estimate}}</view>
              <view class="item-arrow">â€º</view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¢å•åˆ—è¡¨ï¼ˆä»…åˆ›å»ºè€…å¯è§ï¼‰ -->
    <view class="orders-section" wx:if="{{isOwner && orders.length > 0}}">
      <view class="section-title">è®¢å•åˆ—è¡¨</view>
      <view class="orders-list">
        <view
          class="order-card"
          wx:for="{{orders}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="onOrderTap"
        >
          <view class="order-header">
            <text class="order-id">è®¢å• #{{item.id}}</text>
            <text class="order-status">{{item.statusText || item.order_status}}</text>
          </view>
          <view class="order-info">
            <text class="order-item">{{item.itemLabel || item.item_label || 'ç‰©å“'}}</text>
            <text class="order-amount">Â¥{{item.total_amount}}</text>
          </view>
          <view class="order-time">{{item.created_at}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ†äº«æ¨¡æ€æ¡† -->
  <view class="share-modal" wx:if="{{showShareModal}}" bindtap="onCloseShareModal">
    <view class="share-content" catchtap="">
      <view class="share-title">åˆ†äº«æ´»åŠ¨</view>
      <view class="share-link">
        <text class="link-text">{{linkId || activity.shareable_link}}</text>
        <button class="copy-btn" bindtap="onCopyLink">å¤åˆ¶</button>
      </view>
      <view class="share-qrcode" wx:if="{{activity.qr_code_url}}">
        <image src="{{activity.qr_code_url}}" mode="aspectFit"></image>
      </view>
      <button class="close-btn" bindtap="onCloseShareModal">å…³é—­</button>
    </view>
  </view>

  <!-- å¯†ç éªŒè¯æ¨¡æ€æ¡† -->
  <view class="password-modal" wx:if="{{showPasswordModal}}">
    <view class="password-content">
      <view class="password-title">ğŸ”’ æ´»åŠ¨éœ€è¦å¯†ç </view>
      <view class="password-hint" wx:if="{{passwordHint}}">
        æç¤ºï¼š{{passwordHint}}
      </view>
      <input 
        class="password-input" 
        type="text"
        placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç "
        value="{{inputPassword}}"
        bindinput="onPasswordInput"
        maxlength="8"
      />
      <view class="password-error" wx:if="{{passwordError}}">
        {{passwordError}}
      </view>
      <view class="password-buttons">
        <button class="password-btn cancel" bindtap="onCancelPassword">å–æ¶ˆ</button>
        <button class="password-btn confirm" bindtap="onConfirmPassword">ç¡®è®¤</button>
      </view>
    </view>
  </view>
</view>

